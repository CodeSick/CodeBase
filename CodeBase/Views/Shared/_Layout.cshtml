<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>code.base</title>
    <link href="@Url.Content("~/Content/css/style.css")" rel="stylesheet" type="text/css" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript" language="javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/modernizr/2.5.3/modernizr.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="@Url.Content("~/Scripts/jquery.markitup.js")"></script>
    <script type="text/javascript" src="@Url.Content("~/Content/markitup/sets/bbcode/set.js")"></script>
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Content/markitup/skins/markitup/style.css")" />
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Content/markitup/sets/bbcode/style.css")" />
    <link href="@Url.Content("~/Content/themes/base/jquery.ui.all.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/rateit.css")" rel="Stylesheet" type="text/css"/>
    <link href="@Url.Content("~/Content/pretty/prettify.css")" rel="Stylesheet" type="text/css"/>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Content/pretty/prettify.js")"></script>
    <script type="text/javascript" language="javascript" src="@Url.Content("~/Content/js/jquery.js")"></script>
    <link rel="shortcut icon" href="http://dl.dropbox.com/u/56567183/favicon.ico" />
</head>
<body onload="prettyPrint()">
    <div id="main-container">
        <div id="header-container">
            <div id="header">
                <a href="#" id="logo"></a>
                <div id="search">
                    <input id="searchBox" type="text" />
                </div>
                <div id="nav-top">
                    <ul>
                        <li>@Html.ActionLink("Home", "Index", "Home")</li>
                        <li>@Html.ActionLink("Users", "Index", "Users")</li>
                        <li>@Html.ActionLink("Categories", "Index", "Categories")</li>
                        <li>@Html.ActionLink("Articles", "Index", "Articles")</li>
                        <li>@Html.ActionLink("Q&A","Index","Questions")</li>
                        @if (Request.IsAuthenticated)
                        {
                            <li id="uname" class="user-name">@User.Identity.Name</li>
                            } 
                            else 
                            {
                           <li class="login">@Html.ActionLink("Login", "LogOn", "Account")</li>
                        }
                    </ul>
                </div>
                @if (Request.IsAuthenticated)
                {
                    <div class="user-menu">
                        <ul>
                            <li class="first">User options</li>
                            <li>My Profile</li>
                            <li>My Articles</li>
                            <li>Settings</li>
                            @{string LogOffUrl=Html.BuildUrlFromExpression<AccountController>(c => c.LogOff());}
                            <li class="last" id="logout" onclick="location.href='@LogOffUrl'">Sign out</li>
                        </ul>
                    </div>
                }
            </div>
        </div>
        <div id="content-container">
            <div id="content">
                <div id="message">
                    @TempData["Message"]
                </div>
                @RenderBody()
            </div>
        </div>
    </div>
    <div id="footer-container">
        <div id="footer">
            <dl>
                <dt>About</dt>
                <dd><a href="#">Contact us</a></dd>
                <dd><a href="#">About us</a></dd>
                <dd><a href="#">Team</a></dd>
                <dd><a href="#">Terms</a></dd>
            </dl>
            <dl>
                <dt>Navigation</dt>
                <dd><a href="#">Home</a></dd>
                <dd><a href="#">Code</a></dd>
                <dd><a href="#">Articles</a></dd>
                <dd><a href="#">Forums</a></dd>
                <dd><a href="#">Support</a></dd>
            </dl>
            <dl>
                <dt>Extra</dt>
                <dd><a href="#">API</a></dd>
                <dd><a href="#">Media Kit</a></dd>
                <dd><a href="#">Android App</a></dd>
                <dd><a href="#">iPhone App</a></dd>
            </dl>
            <dl id="connect">
                <dt>Connect</dt>
                <dd><a href="#" id="connect-twitter">Twitter</a></dd>
                <dd><a href="#" id="connect-facebook">Facebook</a></dd>
                <dd><a href="#" id="connect-rss">RSS</a></dd>
            </dl>
            <div id="footer-copy"><span>&copy; 2012 code.base</span></div>
                  <div id="auth-status" style="float:  right">
                    <div id="auth-loggedout">
                      <a href="#" id="auth-loginlink">Facebook login</a>
                    </div>
                    <div id="auth-loggedin" style="display:none">
                      Hi, <span id="auth-displayname"></span>  
                    (<a href="#" id="auth-logoutlink">Facebook logout</a>)
                   </div>
                </div>
        </div>
    </div>
    <script type="text/javascript">



    // Stolen from StackOverflow. Find all </code><pre><code>
    // elements on the page and add the "prettyprint" style. If at least one
    // prettyprint element was found, call the Google Prettify prettyPrint() API.
    //http://sstatic.net/so/js/master.js?v=6523
    function styleCode() {

        var a = false;

        $("code").each(function () {
            if (!$(this).hasClass("prettyprint prettyprinted")) {
                $(this).addClass("prettyprint prettyprinted");
                a = true
            }
        });

        if (a) { prettyPrint() }
    }

    $(function () {

        styleCode();

    });

    $("#logout").click(function () {
        FB.logout();
    });

    $("#dialog-confirm").css("display", "none");
    $("#trigger").click(function () {
        $("#dialog-confirm").dialog({
            resizable: false,
            height: 170,
            modal: true,
            buttons: {
                "Subscribe/Unsubscribe": function () {
                    $.ajax({
                        url: '@Url.Action("Subscribe","Questions")',
                        type: "POST",
                        data: { "questionid": '@Model.question.QuestionId' },
                        success: function (data) {
                            if (data == "subscribed") {
                                $("#dialog-confirm").html("<span style=\"color: red\">You are now subscribed to this question</span>");
                            } else {
                                $("#dialog-confirm").html("<span style=\"color: red\">Your subscription to this question has been cancelled</span>");
                            }
                        }
                    });

                },
                Cancel: function () {
                    $(this).dialog("close");
                }
            }
        });
    });

    $("#searchBox").autocomplete({
        source: function (request, response) {
            $.ajax({
                url: '@Url.Action("SearchArticlesJson","Search")',
                type: "GET", dataType: "json",
                data: { data: request.term, maxResults: 10 },
                success: function (data) {
                    response($.map(data, function (item) {
                        return { label: item.name, value: item.name, id: item.id }
                    }))
                }
            })
        },
        select: function (event, ui) {
            window.location.href = "/Articles/" + ui.item.id;
        }
    });

    // Load the SDK Asynchronously
    (function (d) {
        var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
        if (d.getElementById(id)) { return; }
        js = d.createElement('script'); js.id = id; js.async = true;
        js.src = "//connect.facebook.net/en_US/all.js";
        ref.parentNode.insertBefore(js, ref);
    }(document));

    // Init the SDK upon load
    window.fbAsyncInit = function () {
        FB.init({
            appId: '307745619299083', // App ID
            channelUrl: '//' + window.location.hostname + '/channel', // Path to your Channel File
            status: true, // check login status
            cookie: true, // enable cookies to allow the server to access the session
            xfbml: true  // parse XFBML
        });

        // listen for and handle auth.statusChange events
        FB.Event.subscribe('auth.statusChange', function (response) {
            if (response.authResponse) {
                // user has auth'd your app and is logged into Facebook
                var accessToken = response.authResponse.accessToken;

                $.ajax({
                    url: '@Url.Action("Login","Facebook")',
                    type: "POST",
                    data: { "accessToken": response.authResponse.accessToken },
                    success: function (data) {
                        if (data == "error") {
                            alert("Something went wrong");
                        } 
                    }
                });

                FB.api('/me', function (me) {
                    if (me.name) {
                        document.getElementById('auth-displayname').innerHTML = me.name;
                    }
                })
                document.getElementById('auth-loggedout').style.display = 'none';
                document.getElementById('auth-loggedin').style.display = 'block';
            } else {
                // user has not auth'd your app, or is not logged into Facebook
                document.getElementById('auth-loggedout').style.display = 'block';
                document.getElementById('auth-loggedin').style.display = 'none';
            }
        });

        document.getElementById('auth-loginlink').addEventListener('click', function () {
            FB.login();
        });
        document.getElementById('auth-logoutlink').addEventListener('click', function () {
            $.ajax({
                url: '@Url.Action("Logout","Facebook")',
                type: "POST",
                data: { "accessToken": response.authResponse.accessToken }
            });
            FB.logout();
        });
    }

    </script>
</body>
</html>